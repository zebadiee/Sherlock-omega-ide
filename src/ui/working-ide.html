<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sherlock Ω IDE - Working Version</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
    <style>
        .file-item:hover { background-color: rgba(75, 85, 99, 0.5); }
        .file-item.active { background-color: rgba(59, 130, 246, 0.3); }
    </style>
</head>
<body class="bg-gray-900 text-white h-screen overflow-hidden">
    
    <!-- Simple API Key Setup -->
    <div id="setup-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-lg font-semibold mb-4">Setup Sherlock Ω</h3>
            <p class="text-sm text-gray-300 mb-4">Enter your OpenRouter API key to enable AI features:</p>
            
            <input 
                id="api-key" 
                type="password" 
                placeholder="sk-or-v1-..."
                class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 mb-4 focus:outline-none focus:border-blue-500"
            >
            
            <div class="flex space-x-3">
                <button id="save-key" class="flex-1 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">
                    Save & Continue
                </button>
                <button id="skip-setup" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded">
                    Skip (Demo Mode)
                </button>
            </div>
            
            <p class="text-xs text-gray-400 mt-3">
                Get your free API key at <a href="https://openrouter.ai" target="_blank" class="text-blue-400">openrouter.ai</a>
            </p>
        </div>
    </div>

    <!-- Main IDE -->
    <div class="flex flex-col h-screen">
        
        <!-- Header -->
        <div class="bg-gray-800 border-b border-gray-700 px-4 py-2 flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <i data-lucide="shield" class="w-5 h-5 text-blue-400"></i>
                <span class="font-bold">Sherlock Ω IDE</span>
                <span id="mode-indicator" class="text-xs bg-gray-700 px-2 py-1 rounded">Demo Mode</span>
            </div>
            
            <div class="flex items-center space-x-3">
                <button id="settings-btn" class="text-gray-400 hover:text-white">
                    <i data-lucide="settings" class="w-4 h-4"></i>
                </button>
            </div>
        </div>

        <div class="flex flex-1 overflow-hidden">
            
            <!-- File Explorer -->
            <div class="w-64 bg-gray-800 border-r border-gray-700">
                <div class="p-3 border-b border-gray-700">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-semibold">FILES</span>
                        <button id="new-file" class="text-gray-400 hover:text-white">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
                
                <div id="file-list" class="p-2">
                    <!-- Files will be added here -->
                </div>
            </div>

            <!-- Editor -->
            <div class="flex-1 flex flex-col">
                <div id="editor-tabs" class="bg-gray-800 border-b border-gray-700 px-2 py-1 min-h-[40px] flex items-center">
                    <!-- Tabs will be added here -->
                </div>
                
                <div id="editor-container" class="flex-1"></div>
            </div>

            <!-- AI Chat -->
            <div class="w-80 bg-gray-800 border-l border-gray-700 flex flex-col">
                
                <div class="p-3 border-b border-gray-700">
                    <div class="flex items-center space-x-2">
                        <i data-lucide="brain" class="w-5 h-5 text-purple-400"></i>
                        <span class="font-semibold">AI Assistant</span>
                    </div>
                </div>

                <div id="chat-area" class="flex-1 overflow-y-auto p-3 space-y-3">
                    <div class="bg-gray-700 rounded p-3">
                        <div class="flex items-center space-x-2 mb-2">
                            <i data-lucide="shield" class="w-4 h-4 text-blue-400"></i>
                            <span class="text-sm font-semibold">Sherlock Ω</span>
                        </div>
                        <p class="text-sm">Hello! I can help you build applications. Try asking:</p>
                        <ul class="text-xs mt-2 space-y-1 text-gray-300">
                            <li>• "What is 2+2?" (I can do math)</li>
                            <li>• "Create a React component"</li>
                            <li>• "Build a REST API"</li>
                            <li>• "Explain JavaScript promises"</li>
                        </ul>
                    </div>
                </div>

                <div class="border-t border-gray-700 p-3">
                    <div class="flex space-x-2">
                        <input 
                            id="chat-input" 
                            type="text" 
                            placeholder="Ask me anything..."
                            class="flex-1 bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm focus:outline-none focus:border-purple-500"
                        >
                        <button id="send-message" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded">
                            <i data-lucide="send" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="bg-gray-800 border-t border-gray-700 px-4 py-1 flex items-center justify-between text-sm">
            <div class="flex items-center space-x-4">
                <span id="current-file-status">Welcome.md</span>
                <span class="text-gray-400">|</span>
                <span id="cursor-info">Ln 1, Col 1</span>
            </div>
            
            <div class="flex items-center space-x-4">
                <span id="ai-status" class="text-gray-400">AI: Demo Mode</span>
            </div>
        </div>
    </div>

    <script>
        // Simple working AI system
        class WorkingAI {
            constructor() {
                this.apiKey = localStorage.getItem('openrouter-key') || '';
                this.isDemo = !this.apiKey;
                this.updateStatus();
            }

            async ask(question) {
                if (this.isDemo) {
                    return this.demoResponse(question);
                }

                try {
                    const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.apiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: 'anthropic/claude-3-haiku',
                            messages: [
                                {
                                    role: 'system',
                                    content: 'You are Sherlock Ω, a helpful AI assistant in a code editor. Be concise and helpful.'
                                },
                                {
                                    role: 'user',
                                    content: question
                                }
                            ],
                            max_tokens: 1000
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status}`);
                    }

                    const data = await response.json();
                    return data.choices[0].message.content;
                } catch (error) {
                    console.error('AI Error:', error);
                    return `Sorry, I encountered an error: ${error.message}. Try demo mode instead.`;
                }
            }

            demoResponse(question) {
                const q = question.toLowerCase();
                
                // Math questions
                if (q.includes('2+2') || q.includes('2 + 2')) {
                    return '2 + 2 = 4\n\nI can do basic math! Try asking me to create some code next.';
                }
                
                if (q.includes('what is') && (q.includes('+') || q.includes('-') || q.includes('*') || q.includes('/'))) {
                    try {
                        const mathExpression = question.match(/[\d\+\-\*\/\s\(\)\.]+/g)?.[0];
                        if (mathExpression) {
                            const result = Function(`"use strict"; return (${mathExpression})`)();
                            return `${mathExpression} = ${result}`;
                        }
                    } catch (e) {
                        return "I can do basic math like 2+2, 10*5, etc. What would you like to calculate?";
                    }
                }

                // Code generation
                if (q.includes('create') || q.includes('build') || q.includes('make')) {
                    if (q.includes('react') || q.includes('component')) {
                        return this.generateReactComponent();
                    }
                    if (q.includes('api') || q.includes('server')) {
                        return this.generateAPI();
                    }
                    if (q.includes('function')) {
                        return this.generateFunction();
                    }
                }

                // Explanations
                if (q.includes('explain') || q.includes('what is') || q.includes('how does')) {
                    if (q.includes('promise')) {
                        return 'JavaScript Promises are objects that represent the eventual completion or failure of an asynchronous operation. They have three states: pending, fulfilled, or rejected.\n\nExample:\n```javascript\nconst promise = new Promise((resolve, reject) => {\n  setTimeout(() => resolve("Done!"), 1000);\n});\n\npromise.then(result => console.log(result));\n```';
                    }
                    if (q.includes('async')) {
                        return 'Async/await is a syntax that makes it easier to work with Promises. The async keyword makes a function return a Promise, and await pauses execution until the Promise resolves.\n\nExample:\n```javascript\nasync function fetchData() {\n  const response = await fetch("/api/data");\n  const data = await response.json();\n  return data;\n}\n```';
                    }
                }

                // Default responses
                const responses = [
                    "I'm here to help! Try asking me to create code, explain concepts, or do some math.",
                    "I can help you build applications, explain programming concepts, or answer questions. What would you like to know?",
                    "Ask me to create a React component, build an API, or explain how something works!",
                    "I'm ready to help with coding, explanations, or calculations. What can I do for you?"
                ];
                
                return responses[Math.floor(Math.random() * responses.length)];
            }

            generateReactComponent() {
                const componentName = 'MyComponent';
                const code = `import React, { useState } from 'react';

const ${componentName} = () => {
  const [count, setCount] = useState(0);

  return (
    <div className="component">
      <h2>${componentName}</h2>
      <p>Count: {count}</p>
      <button onClick={() => setCount(count + 1)}>
        Increment
      </button>
    </div>
  );
};

export default ${componentName};`;

                // Create the file
                ide.createFile(`${componentName}.jsx`, code, 'javascript');
                
                return `I've created a React component called ${componentName}.jsx! It includes:\n• State management with useState\n• Click handler\n• Clean JSX structure\n\nCheck the file explorer to see the new file.`;
            }

            generateAPI() {
                const code = `const express = require('express');
const app = express();
const port = 3000;

// Middleware
app.use(express.json());

// Routes
app.get('/', (req, res) => {
  res.json({ message: 'API is running!' });
});

app.get('/api/users', (req, res) => {
  res.json([
    { id: 1, name: 'John Doe', email: 'john@example.com' },
    { id: 2, name: 'Jane Smith', email: 'jane@example.com' }
  ]);
});

app.post('/api/users', (req, res) => {
  const { name, email } = req.body;
  const newUser = { id: Date.now(), name, email };
  res.status(201).json(newUser);
});

app.listen(port, () => {
  console.log(\`Server running at http://localhost:\${port}\`);
});`;

                ide.createFile('server.js', code, 'javascript');
                
                return "I've created a REST API server in server.js! It includes:\n• Express.js setup\n• GET /api/users endpoint\n• POST /api/users endpoint\n• JSON middleware\n\nRun with: node server.js";
            }

            generateFunction() {
                const code = `// Utility function generated by Sherlock Ω
function processData(input) {
  // Validate input
  if (!input || typeof input !== 'object') {
    throw new Error('Invalid input: expected an object');
  }

  // Process the data
  const result = {
    ...input,
    processed: true,
    timestamp: new Date().toISOString(),
    id: Math.random().toString(36).substr(2, 9)
  };

  return result;
}

// Example usage
const data = { name: 'John', age: 30 };
const processed = processData(data);
console.log(processed);

module.exports = { processData };`;

                ide.createFile('utils.js', code, 'javascript');
                
                return "I've created a utility function in utils.js! It includes:\n• Input validation\n• Data processing\n• Error handling\n• Example usage\n\nThe function adds metadata to any object you pass to it.";
            }

            setApiKey(key) {
                this.apiKey = key;
                this.isDemo = !key;
                localStorage.setItem('openrouter-key', key);
                this.updateStatus();
            }

            updateStatus() {
                const statusEl = document.getElementById('ai-status');
                const modeEl = document.getElementById('mode-indicator');
                
                if (this.isDemo) {
                    statusEl.textContent = 'AI: Demo Mode';
                    statusEl.className = 'text-yellow-400';
                    modeEl.textContent = 'Demo Mode';
                    modeEl.className = 'text-xs bg-yellow-600 px-2 py-1 rounded';
                } else {
                    statusEl.textContent = 'AI: Connected';
                    statusEl.className = 'text-green-400';
                    modeEl.textContent = 'AI Mode';
                    modeEl.className = 'text-xs bg-green-600 px-2 py-1 rounded';
                }
            }
        }

        // Simple IDE system
        class SimpleIDE {
            constructor() {
                this.files = {
                    'Welcome.md': {
                        content: '# Welcome to Sherlock Ω IDE\n\nThis is a working AI-powered IDE!\n\n## Try these:\n\n1. Ask the AI: "What is 2+2?"\n2. Ask: "Create a React component"\n3. Ask: "Build a REST API"\n4. Ask: "Explain JavaScript promises"\n\nThe AI will actually respond and generate real code files!',
                        language: 'markdown'
                    }
                };
                this.currentFile = 'Welcome.md';
                this.editor = null;
                
                this.initEditor();
                this.renderFiles();
                this.openFile('Welcome.md');
            }

            initEditor() {
                require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' } });
                require(['vs/editor/editor.main'], () => {
                    this.editor = monaco.editor.create(document.getElementById('editor-container'), {
                        value: this.files['Welcome.md'].content,
                        language: 'markdown',
                        theme: 'vs-dark',
                        automaticLayout: true,
                        fontSize: 14
                    });

                    this.editor.onDidChangeCursorPosition((e) => {
                        document.getElementById('cursor-info').textContent = 
                            `Ln ${e.position.lineNumber}, Col ${e.position.column}`;
                    });
                });
            }

            createFile(name, content, language = 'javascript') {
                this.files[name] = { content, language };
                this.renderFiles();
                this.openFile(name);
            }

            openFile(name) {
                if (!this.files[name] || !this.editor) return;
                
                this.currentFile = name;
                const file = this.files[name];
                
                this.editor.setValue(file.content);
                monaco.editor.setModelLanguage(this.editor.getModel(), file.language);
                
                document.getElementById('current-file-status').textContent = name;
                this.renderFiles();
                this.renderTabs();
            }

            renderFiles() {
                const fileList = document.getElementById('file-list');
                fileList.innerHTML = '';

                Object.keys(this.files).forEach(name => {
                    const fileEl = document.createElement('div');
                    fileEl.className = `file-item cursor-pointer px-2 py-1 rounded text-sm flex items-center space-x-2 ${this.currentFile === name ? 'active' : ''}`;
                    
                    const icon = this.getFileIcon(name);
                    fileEl.innerHTML = `<i data-lucide="${icon}" class="w-4 h-4"></i><span>${name}</span>`;
                    
                    fileEl.addEventListener('click', () => this.openFile(name));
                    fileList.appendChild(fileEl);
                });

                lucide.createIcons();
            }

            renderTabs() {
                const tabsEl = document.getElementById('editor-tabs');
                if (this.currentFile) {
                    tabsEl.innerHTML = `
                        <div class="bg-gray-700 px-3 py-1 rounded-t text-sm flex items-center space-x-2">
                            <i data-lucide="${this.getFileIcon(this.currentFile)}" class="w-4 h-4"></i>
                            <span>${this.currentFile}</span>
                        </div>
                    `;
                    lucide.createIcons();
                }
            }

            getFileIcon(name) {
                const ext = name.split('.').pop().toLowerCase();
                const icons = {
                    'js': 'file-code', 'jsx': 'file-code', 'ts': 'file-code', 'tsx': 'file-code',
                    'html': 'file-code', 'css': 'file-code', 'json': 'braces',
                    'md': 'file-text', 'txt': 'file-text'
                };
                return icons[ext] || 'file';
            }
        }

        // Initialize
        const ai = new WorkingAI();
        const ide = new SimpleIDE();

        // Chat functionality
        function addMessage(sender, content, isUser = false) {
            const chatArea = document.getElementById('chat-area');
            const messageEl = document.createElement('div');
            messageEl.className = `${isUser ? 'bg-blue-600' : 'bg-gray-700'} rounded p-3`;
            
            messageEl.innerHTML = `
                <div class="flex items-center space-x-2 mb-2">
                    <i data-lucide="${isUser ? 'user' : 'shield'}" class="w-4 h-4 ${isUser ? 'text-blue-200' : 'text-purple-400'}"></i>
                    <span class="text-sm font-semibold">${sender}</span>
                </div>
                <div class="text-sm whitespace-pre-wrap">${content}</div>
            `;
            
            chatArea.appendChild(messageEl);
            chatArea.scrollTop = chatArea.scrollHeight;
            lucide.createIcons();
        }

        // Event listeners
        document.getElementById('send-message').addEventListener('click', async () => {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            addMessage('You', message, true);
            input.value = '';
            
            try {
                const response = await ai.ask(message);
                addMessage('Sherlock Ω', response);
            } catch (error) {
                addMessage('Sherlock Ω', `Error: ${error.message}`);
            }
        });

        document.getElementById('chat-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('send-message').click();
            }
        });

        document.getElementById('save-key').addEventListener('click', () => {
            const key = document.getElementById('api-key').value.trim();
            ai.setApiKey(key);
            document.getElementById('setup-modal').style.display = 'none';
        });

        document.getElementById('skip-setup').addEventListener('click', () => {
            document.getElementById('setup-modal').style.display = 'none';
        });

        document.getElementById('settings-btn').addEventListener('click', () => {
            document.getElementById('setup-modal').style.display = 'flex';
            document.getElementById('api-key').value = ai.apiKey;
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            if (ai.apiKey) {
                document.getElementById('setup-modal').style.display = 'none';
            }
        });
    </script>
</body>
</html>